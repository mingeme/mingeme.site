---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import dayjs from 'dayjs';
import utc from 'dayjs/plugin/utc';
import timezone from 'dayjs/plugin/timezone';
import 'dayjs/locale/zh-cn';

dayjs.extend(utc);
dayjs.extend(timezone);
dayjs.locale('zh-cn');

const title = `归档 | Mingeme's blog`;

const posts = (await getCollection('posts'))
  .filter((post) => post.data.public)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

const postsByYear = new Map<number, typeof posts>();

for (const post of posts) {
  const year = dayjs(post.data.pubDate).tz('Asia/Shanghai').year();
  if (!postsByYear.has(year)) {
    postsByYear.set(year, []);
  }
  postsByYear.get(year)?.push(post);
}

const archiveYears = Array.from(postsByYear.keys()).sort((a, b) => b - a);
---

<BaseLayout title={title}>
  <div class="mx-auto w-full max-w-4xl px-4 py-12 sm:px-6 lg:px-8 lg:py-16">
    <header class="mb-12">
      <h1 class="text-4xl font-bold text-text-light">归档</h1>
      <p class="mt-3 text-base text-text-light/70">按年份整理的文章记录。时间会继续向前，写作也会。</p>
    </header>

    <div class="space-y-12">
      {
        archiveYears.map((year) => (
          <section class="space-y-6">
            <h2 class="sticky top-4 z-10 bg-background-light/90 px-2 text-2xl font-semibold text-primary backdrop-blur">
              {year}
            </h2>
            <div class="relative border-l border-text-light/10 pl-8">
              {postsByYear.get(year)?.map((post) => {
                const formattedDate = dayjs(post.data.pubDate).tz('Asia/Shanghai').format('YYYY年M月D日');
                const summary = typeof post.data.description === 'string' ? post.data.description : '';
                return (
                  <article class="group relative mb-10">
                    <div class="absolute left-[-1.65rem] top-1 h-3 w-3 rounded-full bg-primary/40 transition group-hover:bg-primary" />
                    <time class="text-sm text-text-light/60">{formattedDate}</time>
                    <h3 class="mt-1 text-lg font-semibold text-text-light transition-colors group-hover:text-primary">
                      <a href={`/posts/${post.slug}`} class="no-underline">
                        {post.data.title}
                      </a>
                    </h3>
                    {summary && <p class="mt-2 text-sm leading-relaxed text-text-light/70">{summary}</p>}
                  </article>
                );
              })}
            </div>
          </section>
        ))
      }
    </div>
  </div>
</BaseLayout>
