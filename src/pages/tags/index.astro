---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const posts = await getCollection('posts');
const tagCounter = new Map<string, number>();

for (const post of posts) {
  if (!post.data.public) continue;
  const tags = Array.isArray(post.data.tags) ? post.data.tags : [];
  for (const tag of tags) {
    if (!tag || typeof tag !== 'string') continue;
    const current = tagCounter.get(tag) ?? 0;
    tagCounter.set(tag, current + 1);
  }
}

const tags = Array.from(tagCounter.entries())
  .map(([name, count]) => ({
    name,
    count,
    href: `/tags/${encodeURIComponent(name)}`,
  }))
  .sort((a, b) => {
    if (b.count === a.count) {
      return a.name.localeCompare(b.name, 'zh-CN');
    }
    return b.count - a.count;
  });
---

<BaseLayout title={`标签 | Mingeme's blog`}>
  <div class="mx-auto w-full max-w-4xl px-4 py-12 sm:px-6 lg:px-8 lg:py-16">
    <section class="text-center">
      <h1 class="text-4xl font-bold text-primary sm:text-5xl">标签</h1>
      <p class="mt-4 text-base text-text-light/70">
        按标签快速浏览文章。目前共收录 <span class="font-semibold text-primary">{tags.length}</span> 个标签。
      </p>
    </section>

    {
      tags.length === 0 ? (
        <p class="mt-12 text-center text-sm text-text-light/60">暂时还没有标签，期待新的内容出现。</p>
      ) : (
        <div class="mt-12 flex flex-wrap justify-center gap-x-6 gap-y-4">
          {tags.map((tag) => (
            <a href={tag.href} class="px-3 py-1.5 text-base font-medium text-text-light transition hover:text-primary">
              {tag.name}
              <span class="ml-1 text-primary/60">({tag.count})</span>
            </a>
          ))}
        </div>
      )
    }
  </div>
</BaseLayout>
