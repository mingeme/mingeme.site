---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const tagSet = new Set<string>();

  for (const post of posts) {
    if (!post.data.public) continue;
    const tags = Array.isArray(post.data.tags) ? post.data.tags : [];
    for (const tag of tags) {
      if (typeof tag === 'string' && tag.length > 0) {
        tagSet.add(tag);
      }
    }
  }

  return Array.from(tagSet).map((tag) => ({
    params: { tag: encodeURIComponent(tag) },
    props: { tag },
  }));
}

const tagName = Astro.props?.tag ?? decodeURIComponent(Astro.params.tag ?? '');

const posts = (await getCollection('posts'))
  .filter((post) => post.data.public && Array.isArray(post.data.tags) && post.data.tags.includes(tagName))
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

const title = `${tagName} | 标签归档`;
---

<BaseLayout title={title}>
  <div class="mx-auto w-full max-w-4xl space-y-10 px-4 py-12 sm:px-6 lg:px-8 lg:py-16">
    <section class="space-y-3 text-center">
      <p class="text-sm text-[#211811]/60">标签</p>
      <h1 class="text-3xl font-bold text-[#e66e19] sm:text-4xl">{tagName}</h1>
      <p class="text-base text-[#211811]/70">
        共 {posts.length} 篇文章
      </p>
    </section>

    {
      posts.length === 0 ? (
        <p class="text-center text-sm text-[#211811]/60">暂时还没有归档相关文章。</p>
      ) : (
        <div class="space-y-4">
          {posts.map((post) => (
            <PostCard url={post.slug} frontmatter={post.data} />
          ))}
        </div>
      )
    }
  </div>
</BaseLayout>
