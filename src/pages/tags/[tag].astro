---
import { getCollection } from 'astro:content';
import PageLayout from '@/layouts/PageLayout.astro';
import Container from '@/components/Container.astro';
import ArrowCard from '@/components/ArrowCard.astro';
import { TAGS } from '@/consts';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tagSet = new Set<string>();

  for (const post of posts) {
    if (!post.data.public || post.data.draft) continue;
    const tags = Array.isArray(post.data.tags) ? post.data.tags : [];
    for (const tag of tags) {
      if (typeof tag === 'string' && tag.length > 0) {
        tagSet.add(tag);
      }
    }
  }

  return Array.from(tagSet).map((tag) => ({
    params: { tag: encodeURIComponent(tag) },
    props: { tag },
  }));
}

const tagName = Astro.props?.tag ?? decodeURIComponent(Astro.params.tag ?? '');

const posts = (await getCollection('blog'))
  .filter(
    (post) =>
      post.data.public &&
      !post.data.draft &&
      !post.data.misc &&
      Array.isArray(post.data.tags) &&
      post.data.tags.includes(tagName),
  )
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const title = `${tagName} | ${TAGS.TITLE}`;
---

<PageLayout title={title} description={`标签 ${tagName} 下的所有文章`}>
  <Container>
    <div class="space-y-10">
      <div class="animate space-y-2 text-center">
        <p class="text-sm opacity-75">标签</p>
        <h1 class="text-3xl font-semibold text-black dark:text-white">
          {tagName}
        </h1>
        <p class="text-sm opacity-75">
          共 {posts.length} 篇文章
        </p>
      </div>

      {
        posts.length === 0 ? (
          <p class="animate text-center text-sm opacity-75">暂时还没有相关文章。</p>
        ) : (
          <div class="animate space-y-4">
            <ul class="flex flex-col gap-4">
              {posts.map((post) => (
                <li>
                  <ArrowCard entry={post} />
                </li>
              ))}
            </ul>
          </div>
        )
      }
    </div>
  </Container>
</PageLayout>
